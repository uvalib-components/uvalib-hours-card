<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../byutv-jsonp/byutv-jsonp.html">
<link rel="import" href="../uvalib-card/uvalib-card.html">

<!--
`uvalib-hours-card`
Library hours information displayed in a card section

### Styling

The following custom properties are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--uvalib-hours-card-row-bkgrd-color-odd` | Background color of odd rows | `Based on uvalib-theme --color-light-blue`
`--uvalib-hours-card-row-bkgrd-color-even` | Background color of even rows | `Based on uvalib-theme --color-white`

@demo demo/index.html
-->

<dom-module id="uvalib-hours-card">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      .row-bkgrd-color-odd {
        background-color: var(--uvalib-hours-card-row-bkgrd-color-odd,--color-light-blue);
        padding-left: -10px;
        padding-right: -10px;
      }

      .row-bkgrd-color-even {
        background-color: var(--uvalib-hours-card-row-bkgrd-color-even,--color-white);
      }
    </style>

    <byutv-jsonp id="hrsData" auto url="{{libraryHoursSource}}" params="{{_libraryHoursParams}}" last-response="{{_springshareData}}"
      debounce-duration="300"></byutv-jsonp>

    <uvalib-card heading="Hours">
      <div class="card-content">
        <template is="dom-repeat" items="{{_libraries}}">
          <div class$="location {{_rowBackgroundColor(index)}}">
            <h2>{{item.name}}</h2>
            <p>
              <span class="today">
                Today {{item.currentDate}}
              </span>
              <span class="hours">
                {{item.hours}}
              </span>
            </p>
          </div>
        </template>
      </div>
      <content></content>
    </uvalib-card>
  </template>

  <script>
    Polymer({

      is: 'uvalib-hours-card',

      properties: {
        /**
         * A comma-delimited string of library locations to be included in the
         * card content. The locations should be the name to be displayed and
         * be able to be found as a string in the LibCal Hours locations.
         */
        locations: {
          type: String,
          value: "alderman,clemons,brown,music",
        },

        /**
         * The vendor URL (less parameters) for retrieving today's hours in JSON format.
         */
        libraryHoursSource: {
          type: String,
          value: "https://api3.libcal.com/api_hours_today.php"
        },

        /**
         * The Springshare parameters for retrieving the current day's hours.
         */
        _libraryHoursParams: {
          type: Object,
          computed: "_getParams(_iid,_lid,_format)"
        },

        /**
         * Institution ID parameter needed to get Springshare hours.
         */
        _iid: {
          type: Number,
          value: 863
        },

        /**
         * Library ID parameter needed to get Springshare hours. 0 retrieves all libraries.
         */
        _lid: {
          type: Number,
          value: 0
        },

        /**
         * Data format parameter needed to get Springshare hours.
         */
        _format: {
          type: String,
          value: "json"
        },

        /**
         * JSON data returned from Springshare API call.
         */
        _springshareData: Object,

        /**
         * Library locations with hours for use in generating this card content.
         */
        _libraries: {
          type: Array,
          computed: "_buildLibrariesHours(_springshareData)"
        }
      },

      /**
       * Get the Springshare parameters into a proper object.
       *
       * @param {Integer} institutionId Springshare institution identifier
       * @param {Integer} libraryId Springshare library identifier
       * @param {String} dataFormat structure of the data returned
       */
      _getParams: function(institutionId,libraryId,dataFormat) {
        return {iid:institutionId , lid:libraryId , format:dataFormat};
      },

      /**
      * When the Springshare hours JSON object is ready then pull the
      * needed locations' hours data into this component's object
      * used to build the list of library hours.
      *
      * @param {Object} data the returned data from the AJAX call
      */
      _buildLibrariesHours: function(data) {
        var libraries = new Array();
        // format today as month/date
        var today = new Date();
        var monthDay = (today.getMonth()+1) + "/" + today.getDate();
        // create libraries array from string of locations
        var libLocations = this.locations.split(",");
        // loop through each library and build
        for (var i=0; i < libLocations.length; i++) {
          var libName = libLocations[i].split(" ");
          var capName = "";
          for (var j=0; j < libName.length; j++) {
            capName += libName[j].charAt(0).toUpperCase() + libName[j].substr(1) + " ";
          }
          var info = {
            name: capName + "Library",
            currentDate: monthDay,
            hours: this._getHours(libLocations[i], data)
          };
          libraries[i] = info;
        }
        return libraries;
      },

      /**
       * Find and return hours for specified library location.
       *
       * @param {String} location one of names specified in locations attribute
       * @param {Object} data the returned data from the AJAX call
       * @return {String}
       */
      _getHours: function(location, data) {
        var hours = "";
        for (var i=0; i < data.locations.length; i++) {
          var libname = data.locations[i].name.toLowerCase();
          if ((libname.indexOf(location.toLowerCase()) >= 0) && (libname.indexOf('library') >= 0)) {
            hours = data.locations[i].rendered;
            break;
          }
        }
        return hours;
      },

      /**
       * Find and return name for specified library location.
       *
       * @param {String} location one of names specified in locations attribute
       * @param {Object} data the returned data from the AJAX call
       * @return {String}
       */
      _getName: function(location, data) {
        var name = "";
        for (var i=0; i < data.locations.length; i++) {
          var libname = data.locations[i].name.toLowerCase();
          if ((libname.indexOf(location.toLowerCase()) >= 0) && (libname.indexOf('library') >= 0)) {
            name = data.locations[i].name;
            break;
          }
        }
        return name;
      },

      /**
       * Adjust Library location row background color based on odd/even item.
       *
       * @param {Integer} index row of dom-repeat item/_libraries being processed
       */
      _rowBackgroundColor: function(index) {
        var clsName = (index % 2) ? 'row-bkgrd-color-even' : 'row-bkgrd-color-odd';
        return clsName;
      },

    });

  </script>
</dom-module>
